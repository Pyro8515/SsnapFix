openapi: 3.0.3
info:
  title: GetDone Backend API
  description: Backend API for GetDone platform - professional services marketplace
  version: 1.0.0
  contact:
    name: GetDone API Support

servers:
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions
    variables:
      project-ref:
        default: your-project-ref

security:
  - bearerAuth: []

paths:
  /api/me:
    get:
      summary: Get current user information
      description: Returns account info, documents, trade compliance, and verification status
      operationId: getMe
      tags:
        - User
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/role/switch:
    post:
      summary: Switch user role
      description: Toggles between customer and professional role (if allowed)
      operationId: switchRole
      tags:
        - User
      responses:
        '200':
          description: Role switched successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleSwitchResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /api/offers:
    get:
      summary: List available offers/jobs
      description: Returns offers the user is eligible for (filtered by trade compliance for professionals)
      operationId: listOffers
      tags:
        - Offers
      parameters:
        - name: trade
          in: query
          schema:
            type: string
          description: Filter by trade type
        - name: lat
          in: query
          schema:
            type: number
          description: Latitude for distance filtering
        - name: lng
          in: query
          schema:
            type: number
          description: Longitude for distance filtering
        - name: max_distance
          in: query
          schema:
            type: number
            default: 50
          description: Maximum distance in km
      responses:
        '200':
          description: List of offers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Offer'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/pro/offers/accept:
    post:
      summary: Accept an offer/job
      description: Accepts an offer with compliance checking. Returns 409 if compliance issues exist.
      operationId: acceptOffer
      tags:
        - Offers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - offer_id
              properties:
                offer_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Offer accepted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OfferAcceptResponse'
        '400':
          description: Bad request (missing offer_id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Offer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Compliance issues or offer already assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stripe/identity/start:
    post:
      summary: Start Stripe Identity verification
      description: Creates a Stripe Identity verification session for the current user
      operationId: startIdentityVerification
      tags:
        - Verification
      responses:
        '200':
          description: Verification session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdentityStartResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/stripe/identity/webhook:
    post:
      summary: Stripe Identity webhook handler
      description: Processes Stripe Identity webhook events (idempotent)
      operationId: identityWebhook
      tags:
        - Webhooks
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StripeWebhookEvent'
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                  message:
                    type: string
                    nullable: true
        '400':
          description: Bad request (missing signature or invalid payload)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro-docs/presign:
    post:
      summary: Generate presigned URL for document upload
      description: Creates a presigned URL for uploading a document to storage
      operationId: presignDocument
      tags:
        - Documents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - doc_type
                - file_name
              properties:
                doc_type:
                  type: string
                doc_subtype:
                  type: string
                file_name:
                  type: string
      responses:
        '200':
          description: Presigned URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignResponse'
        '400':
          description: Bad request (missing required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/pro-docs/submit:
    post:
      summary: Submit document metadata
      description: Saves document metadata after upload and triggers compliance recomputation
      operationId: submitDocument
      tags:
        - Documents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_url
                - doc_type
              properties:
                file_url:
                  type: string
                doc_type:
                  type: string
                doc_subtype:
                  type: string
                number:
                  type: string
                issuer:
                  type: string
                issued_at:
                  type: string
                  format: date
                expires_at:
                  type: string
                  format: date
      responses:
        '200':
          description: Document submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentSubmitResponse'
        '400':
          description: Bad request (missing required fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/payments/start:
    post:
      summary: Start Stripe Connect onboarding
      description: Creates or retrieves Stripe Connect account link for payouts setup
      operationId: startPayments
      tags:
        - Payments
      responses:
        '200':
          description: Account link created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentsStartResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/stripe/payments/webhook:
    post:
      summary: Stripe Payments webhook handler
      description: Processes Stripe Connect webhook events (idempotent)
      operationId: paymentsWebhook
      tags:
        - Webhooks
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StripeWebhookEvent'
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                  message:
                    type: string
                    nullable: true
        '400':
          description: Bad request (missing signature or invalid payload)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/background/start:
    post:
      summary: Start background check process (Optional)
      description: Initiates background check verification for professional users
      operationId: startBackgroundCheck
      tags:
        - Verification
      responses:
        '200':
          description: Background check initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackgroundStartResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/avatar/upload:
    post:
      summary: Upload avatar (temp path)
      description: Creates a presigned URL for uploading avatar to temp path. After upload, call /api/avatar/approve to move to public path.
      operationId: uploadAvatar
      tags:
        - Avatars
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_name
              properties:
                file_name:
                  type: string
                  description: Name of the avatar file
                auto_approve:
                  type: boolean
                  default: false
                  description: Whether to auto-approve after upload
      responses:
        '200':
          description: Presigned URL generated for temp path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvatarUploadResponse'
        '400':
          description: Bad request (missing file_name)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/avatar/approve:
    post:
      summary: Approve avatar and move to public path
      description: Moves avatar from temp path to public path and updates user avatar_url
      operationId: approveAvatar
      tags:
        - Avatars
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - temp_path
                - final_path
              properties:
                temp_path:
                  type: string
                  description: Temporary path where avatar was uploaded
                final_path:
                  type: string
                  description: Final public path for avatar
      responses:
        '200':
          description: Avatar approved and moved to public path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvatarApproveResponse'
        '400':
          description: Bad request (missing paths)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid path (not owned by user)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Temp file not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/jobs:
    post:
      summary: Create a new job
      description: Creates a new job request with location, pricing, and service details
      operationId: createJob
      tags:
        - Jobs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCreateRequest'
      responses:
        '200':
          description: Job created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/jobs/{jobId}/status:
    post:
      summary: Update job status
      description: Updates job status (en_route, arrived, started, completed, cancelled)
      operationId: updateJobStatus
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobStatusUpdateRequest'
      responses:
        '200':
          description: Job status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/jobs/match:
    post:
      summary: Trigger job matching engine
      description: Manually triggers the matching engine to find eligible pros for a job
      operationId: matchJob
      tags:
        - Jobs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                job_id:
                  type: string
                  format: uuid
                  description: Job ID to match
      responses:
        '200':
          description: Matching completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/ratings:
    get:
      summary: Get user ratings
      description: Get all ratings submitted by the current user
      operationId: getRatings
      tags:
        - Ratings
      responses:
        '200':
          description: List of ratings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RatingResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/ratings/{jobId}:
    get:
      summary: Get rating for a job
      description: Get rating for a specific job
      operationId: getRating
      tags:
        - Ratings
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Rating for the job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RatingResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      summary: Create or update rating
      description: Submit a rating for a completed job
      operationId: createRating
      tags:
        - Ratings
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RatingCreateRequest'
      responses:
        '200':
          description: Rating created/updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RatingResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        account_type:
          type: string
          enum: [customer, professional]
        active_role:
          type: string
        can_switch_roles:
          type: boolean
        verification_status:
          type: string
          enum: [pending, approved, rejected]
        avatar_url:
          type: string
          nullable: true
        professional_profile:
          type: object
          nullable: true
          properties:
            services:
              type: array
              items:
                type: string
            identity_status:
              type: string
            payouts_enabled:
              type: boolean
            payouts_status:
              type: string
        documents:
          type: array
          items:
            $ref: '#/components/schemas/DocumentStatus'
        trade_compliance:
          type: array
          items:
            $ref: '#/components/schemas/TradeCompliance'

    DocumentStatus:
      type: object
      properties:
        doc_type:
          type: string
        doc_subtype:
          type: string
          nullable: true
        status:
          type: string
          enum: [pending, approved, rejected, expired, manual_review]
        expires_at:
          type: string
          format: date
          nullable: true
        reason:
          type: string
          nullable: true

    TradeCompliance:
      type: object
      properties:
        trade:
          type: string
        compliant:
          type: boolean
        reason:
          type: string
          nullable: true

    RoleSwitchResponse:
      type: object
      properties:
        active_role:
          type: string

    Offer:
      type: object
      properties:
        id:
          type: string
          format: uuid
        job_title:
          type: string
        description:
          type: string
          nullable: true
        trade:
          type: array
          items:
            type: string
        location_lat:
          type: number
          nullable: true
        location_lng:
          type: number
          nullable: true
        customer_user_id:
          type: string
          format: uuid
          nullable: true
        status:
          type: string
          enum: [open, assigned, completed, cancelled]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PresignResponse:
      type: object
      properties:
        url:
          type: string
          description: Presigned URL for upload
        path:
          type: string
          description: Storage path where file will be uploaded
        token:
          type: string
          description: Upload token for authentication (if required)
          nullable: true
        fields:
          type: object
          description: Additional fields for upload (S3-style, empty for Supabase)
          additionalProperties:
            type: string

    DocumentSubmitResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Document ID
        status:
          type: string
          enum: [pending, approved, rejected, expired, manual_review]
          description: Document verification status
        message:
          type: string
          description: Success message

    IdentityStartResponse:
      type: object
      properties:
        verification_session_id:
          type: string
          description: Stripe Identity verification session ID
        client_secret:
          type: string
          description: Client secret for frontend SDK
        url:
          type: string
          format: uri
          description: URL to redirect user for verification

    PaymentsStartResponse:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Account link URL for Stripe Connect onboarding
        expires_at:
          type: integer
          format: int64
          description: Unix timestamp when link expires
        account_id:
          type: string
          description: Stripe Connect account ID

    OfferAcceptResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether offer was accepted
        offer_id:
          type: string
          format: uuid
          description: ID of accepted offer

    BackgroundStartResponse:
      type: object
      properties:
        background_check_id:
          type: string
          description: Background check verification ID
        status:
          type: string
          enum: [pending, in_progress, completed, failed]
          description: Initial status of background check
        message:
          type: string
          description: Status message

    AvatarUploadResponse:
      type: object
      properties:
        url:
          type: string
          description: Presigned URL for uploading avatar to temp path
        path:
          type: string
          description: Temp path where avatar will be uploaded
        temp_path:
          type: string
          description: Temporary path (avatars-temp/{user_id}/{uuid}.{ext})
        final_path:
          type: string
          description: Final public path (pro-avatars/{user_id}/{uuid}.{ext})
        token:
          type: string
          description: Upload token for authentication
          nullable: true
        auto_approve:
          type: boolean
          description: Whether auto-approve is enabled

    AvatarApproveResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether avatar was approved successfully
        avatar_url:
          type: string
          format: uri
          description: Public URL of the approved avatar
        message:
          type: string
          description: Success message

    StripeWebhookEvent:
      type: object
      description: Stripe webhook event payload structure
      properties:
        id:
          type: string
          description: Event ID (used for idempotency)
        type:
          type: string
          description: Event type (e.g., identity.verification_session.verified, account.updated)
          enum:
            - identity.verification_session.verified
            - identity.verification_session.requires_input
            - identity.verification_session.processing
            - identity.verification_session.canceled
            - account.updated
            - account.application.authorized
            - account.application.deauthorized
        data:
          type: object
          description: Event data object
          properties:
            object:
              type: object
              description: The Stripe object related to the event
              additionalProperties: true
        created:
          type: integer
          format: int64
          description: Unix timestamp of event creation
        livemode:
          type: boolean
          description: Whether event is from live or test mode

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
        reasons:
          type: array
          items:
            type: string
          description: Array of specific reasons for the error (used in 409 responses)
          nullable: true
        details:
          type: object
          description: Additional error details
          nullable: true
          additionalProperties: true

    JobCreateRequest:
      type: object
      required:
        - service_code
        - address
      properties:
        service_code:
          type: string
          description: Service code (e.g., 'plumbing', 'electrical')
        address:
          type: object
          required:
            - lat
            - lng
          properties:
            line1:
              type: string
            city:
              type: string
            state:
              type: string
            zip:
              type: string
            lat:
              type: number
              format: float
            lng:
              type: number
              format: float
        scheduled_start:
          type: string
          format: date-time
          nullable: true
        scheduled_end:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          nullable: true

    JobResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        service_code:
          type: string
        status:
          type: string
          enum: [requested, assigned, en_route, arrived, started, completed, cancelled]
        address:
          type: object
        price_cents:
          type: integer
        platform_fee_cents:
          type: integer
        payout_cents:
          type: integer
        currency:
          type: string
          default: USD
        scheduled_start:
          type: string
          format: date-time
          nullable: true
        scheduled_end:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    JobStatusUpdateRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [en_route, arrived, started, completed, cancelled]
        location:
          type: object
          properties:
            lat:
              type: number
              format: float
            lng:
              type: number
              format: float

    JobStatusResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
        payment_status:
          type: string
        updated_at:
          type: string
          format: date-time

    MatchResponse:
      type: object
      properties:
        message:
          type: string
        matched_count:
          type: integer
        offers:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              pro_user_id:
                type: string
                format: uuid
              status:
                type: string
              expires_at:
                type: string
                format: date-time
              payout_cents:
                type: integer

    RatingCreateRequest:
      type: object
      required:
        - rating
      properties:
        rating:
          type: integer
          minimum: 1
          maximum: 5
          description: Rating from 1 to 5
        comment:
          type: string
          nullable: true

    RatingResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        job_id:
          type: string
          format: uuid
        pro_user_id:
          type: string
          format: uuid
        rating:
          type: integer
        comment:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Conflict:
      description: Conflict (business rule violation)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
